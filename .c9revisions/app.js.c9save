{"ts":1370896254224,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var express = require('express');\nvar twilio = require('twilio');\nvar redis = require('redis');\n\nfunction playTones(twiml,tones){\n  \n  //allow array, string, and number input\n  if(!Array.isArray(tones)){\n    tones = tones.toString().split('');\n  }\n  \n  for(var i = 0; i < tones.length; i++){\n    var tone = tones[i];\n    twiml.play('/dtmf/'\n      + (tone == '#' ? 'pound' : tone == '*' ? 'star' : tone)\n      + '.wav');\n  }\n\n  return twiml;\n}\n\nfunction playToneResponse(res,tones){\n  res.type('text/xml').send(\n    playTones(new twilio.TwimlResponse(), tones)\n      .toString());\n}\n\nmodule.exports = function(cfg){\n  var db = redis.createClient(cfg.redis.port, cfg.redis.hostname,\n    {no_ready_check: true});\n  db.auth(cfg.redis.password);\n  var app = express();\n\n  app.use(express.bodyParser());\n  app.use(express.favicon());\n  app.use('/dtmf',express.static(__dirname+'/dtmf'));\n\n  app.get('/',function(req,res){\n    res.render('index.jade');\n  });\n  app.post('/',function(req,res,next){\n    res.render('index.jade');\n    db.set(req.body.number,req.body.sequence,'EX 300', function(err,status) {\n      if (err) return next(err);\n      if (status != 'OK') console.error('Redis returned status ' + status);\n      res.redirect('/monitor?number=' + req.body.number);\n    });\n  });\n  app.get('/monitor',function(req,res,next){\n    db.multi()\n      .get(req.query.number)\n      .ttl(req.query.number)\n      .exec(function(errs,resp) {\n        if(errs) return next(errs);\n        res.render('monitor.jade',{\n          number: req.query.number,\n          sequence: resp[0],\n          seconds: resp[1]},\n        function(err,text){\n          if(!resp[0]) res.status(404);\n          res.send(text);\n        });\n      });\n  });\n  app.post('/incoming',function(req,res,next){\n    db.get(req.body.Called,function(err,sequence){\n      if (err) return next(err);\n      if (sequence) {\n        playToneResponse(res, sequence);\n      } else {\n        res.send(404);\n      }\n    });\n  });\n\n  app.use(function(req,res){return res.send(404)});\n\n  return app;\n};"]],"start1":0,"start2":0,"length1":0,"length2":2044}]],"length":2044}
